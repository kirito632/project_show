# ğŸš€ High-Performance Distributed IM System (åŸºäºå¾®æœåŠ¡çš„åˆ†å¸ƒå¼å³æ—¶é€šè®¯ç³»ç»Ÿ)

![C++](https://img.shields.io/badge/language-C++17-blue.svg)
![Platform](https://img.shields.io/badge/platform-Linux-lightgrey.svg)
![Build](https://img.shields.io/badge/build-CMake-green.svg)
![Architecture](https://img.shields.io/badge/Architecture-Microservices-orange.svg)

> ä¸€ä¸ªåŸºäº **C++17** å’Œ **Boost.Asio** å®ç°çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼ IM åç«¯ã€‚
> é‡‡ç”¨ **Reactor** æ¨¡å‹ä¸ **gRPC** å¾®æœåŠ¡æ¶æ„ï¼Œè®¾è®¡äº†å…¨å¼‚æ­¥æ•°æ®åº“è¿æ¥æ± ä¸åº”ç”¨å±‚å¯é ä¼ è¾“åè®®ã€‚
> **å®æµ‹æ€§èƒ½**ï¼šå•æœºæ”¯æŒ **20,000+** å¹¶å‘é•¿è¿æ¥ï¼Œå³°å€¼ååé‡ **5,000+ QPS**ã€‚

---

## ğŸ“š ç›®å½•
- [æ ¸å¿ƒç‰¹æ€§](#-æ ¸å¿ƒç‰¹æ€§-features)
- [ç³»ç»Ÿæ¶æ„ä¸ç›®å½•è¯´æ˜](#-ç³»ç»Ÿæ¶æ„ä¸ç›®å½•è¯´æ˜-structure)
- [æ€§èƒ½å‹æµ‹æŠ¥å‘Š](#-æ€§èƒ½å‹æµ‹æŠ¥å‘Š-benchmark)
- [æŠ€æœ¯éš¾ç‚¹å¤ç›˜](#-æŠ€æœ¯éš¾ç‚¹å¤ç›˜-troubleshooting)
- [æ„å»ºä¸è¿è¡Œ](#-æ„å»ºä¸è¿è¡Œ-build)

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§ (Features)
*   **åº•å±‚ç½‘ç»œå°è£…**ï¼šåŸºäº Linux **Epoll** + **Boost.Asio** å°è£…ï¼Œé‡‡ç”¨ **One Loop Per Thread** çº¿ç¨‹æ¨¡å‹ï¼Œæœ€å¤§åŒ–å¤šæ ¸åˆ©ç”¨ç‡ã€‚
*   **åˆ†å¸ƒå¼æ¶æ„**ï¼š
    *   **ç½‘å…³æœåŠ¡ (GateServer)**ï¼šå¤„ç† TCP é•¿è¿æ¥æ¥å…¥ä¸è´Ÿè½½å‡è¡¡ã€‚
    *   **ä¸šåŠ¡æœåŠ¡ (ChatServer é›†ç¾¤)**ï¼šåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå¤„ç†æ¶ˆæ¯è½¬å‘ä¸å­˜å‚¨é€»è¾‘ã€‚
    *   **çŠ¶æ€æœåŠ¡ (StatusServer)**ï¼šé€šè¿‡ gRPC ç»´æŠ¤å…¨å±€ç”¨æˆ·åœ¨çº¿çŠ¶æ€ä¸ Session è·¯ç”±ã€‚
    *   **å¼‚æ„æœåŠ¡ (VerifyServer)**ï¼šå¼•å…¥ Node.js ç”Ÿæ€å¤„ç†é‚®ä»¶/éªŒè¯ç ç­‰ IO å¯†é›†å‹ä»»åŠ¡ã€‚
*   **æ·±åº¦ç¨³å®šæ€§ä¼˜åŒ–**ï¼š
    *   **å¼‚æ­¥ DB è¿æ¥æ± **ï¼šè®¾è®¡æ”¯æŒè¶…æ—¶ç†”æ–­ä¸è‡ªåŠ¨é‡è¿çš„ MySQL è¿æ¥æ± ï¼Œæ¶ˆé™¤åŒæ­¥é˜»å¡ã€‚
    *   **åè®®è®¾è®¡**ï¼šè‡ªå®šä¹‰ **Header+Body** åŒé˜¶æ®µè¯»å–åè®®ï¼Œå½»åº•è§£å†³ TCP ç²˜åŒ…/åŠåŒ…é—®é¢˜ã€‚
    *   **RAII ç®¡ç†**ï¼šåˆ©ç”¨ `std::shared_ptr` ä¸ `weak_ptr` é”å®šå›è°ƒä¸­çš„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸï¼Œé˜²æ­¢ CoreDumpã€‚

---

## ğŸ“‚ ç³»ç»Ÿæ¶æ„ä¸ç›®å½•è¯´æ˜ (Structure)

æœ¬é¡¹ç›®é‡‡ç”¨å¾®æœåŠ¡æ‹†åˆ†ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹æ¨¡å—ï¼š

```text
.
â”œâ”€â”€ ChatServer       // [æ ¸å¿ƒ] ä¸šåŠ¡é€»è¾‘æœåŠ¡èŠ‚ç‚¹ 1 (C++, Asio, MySQL)
â”œâ”€â”€ ChatServer2      // [æ‰©å±•] ä¸šåŠ¡é€»è¾‘æœåŠ¡èŠ‚ç‚¹ 2 (ç”¨äºæ¨¡æ‹Ÿåˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²)
â”œâ”€â”€ GateServer       // [ç½‘å…³] è´Ÿè½½å‡è¡¡ä¸è¿æ¥åˆ†å‘ (C++, Asio)
â”œâ”€â”€ StatusServer     // [çŠ¶æ€] å…¨å±€è·¯ç”±ä¸çŠ¶æ€ç®¡ç† (C++, gRPC)
â”œâ”€â”€ VerifyServer     // [éªŒè¯] éªŒè¯ç /é‚®ä»¶æœåŠ¡ (Node.js å¼‚æ„å¾®æœåŠ¡)
â”œâ”€â”€ ChatClient       // [å®¢æˆ·ç«¯] åŸºäº Qt ç¼–å†™çš„æ¡Œé¢ç«¯èŠå¤©ç•Œé¢
â”œâ”€â”€ docs             // [æ–‡æ¡£] æŠ€æœ¯éš¾ç‚¹å¤ç›˜ä¸ Bug ä¿®å¤æŠ¥å‘Š
â”œâ”€â”€ tests            // [æµ‹è¯•] Python è‡ªåŠ¨åŒ–å‹æµ‹è„šæœ¬
â”œâ”€â”€ CMakeLists.txt   // å…¨å±€æ„å»ºè„šæœ¬
â””â”€â”€ README.md        // é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

---

## ğŸ“Š æ€§èƒ½å‹æµ‹æŠ¥å‘Š (Benchmark)

### 1. æµ‹è¯•ç¯å¢ƒ
*   **ç¯å¢ƒ**: Ubuntu 22.04 LTS (VMware), 2 Cores, 10GB RAM
*   **å†…æ ¸ä¼˜åŒ–**: `ulimit -n = 1,048,576`

### 2. æ ¸å¿ƒæ•°æ®
*   **å¹¶å‘è¿æ¥æ•°**: 20,000+ (è¿æ¥æˆåŠŸç‡ 100%)
*   **å³°å€¼ QPS**: 4,923 msg/s (å•èŠ‚ç‚¹å¤„ç†èƒ½åŠ›)
*   **ç¨³å®šæ€§**: 30åˆ†é’Ÿæ»¡è½½å‹æµ‹ï¼Œæ— å´©æºƒï¼Œæ— å†…å­˜æ³„æ¼ã€‚

### 3. è¯¦ç»†æµ‹è¯•è®°å½• (Test Logs)

| ID | é˜¶æ®µ | å¹¶å‘æ•° | æŒç»­æ—¶é—´ | æˆåŠŸ/å¤±è´¥ | æ€»æ¶ˆæ¯æ•° | QPS (msg/s) | å¤‡æ³¨ |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **T0** | ä¿®å¤å‰ | 1000 | 120s | 1000 / 0 | 193k | 1,601 | å‘ç”Ÿ DB è¿æ¥æ± é˜»å¡ Crash |
| **T1** | ä¿®å¤å | 1000 | 120s | 1000 / 0 | 593k | **4,923** | å³°å€¼ååé‡æµ‹è¯• |
| **T3** | ä¿®å¤å | 2000 | 120s | 2000 / 0 | 375k | 3,116 | å¹¶å‘ç¿»å€æµ‹è¯• |
| **T6** | ä¿®å¤å | 2000 | 1800s | 2000 / 0 | 6.7M+ | 3,771 | **30åˆ†é’Ÿé•¿ç¨³æµ‹è¯• (Stable)** |

---

## ğŸ› ï¸ æŠ€æœ¯éš¾ç‚¹å¤ç›˜ (Troubleshooting)

é’ˆå¯¹é«˜å¹¶å‘åœºæ™¯ä¸‹é‡åˆ°çš„ **MySQL è¿æ¥æ± æ­»é”** ä¸ **æ€§èƒ½æŠ–åŠ¨** é—®é¢˜ï¼Œè¿›è¡Œäº†æ·±åº¦æ’æŸ¥å¹¶è¾“å‡ºä¿®å¤æŠ¥å‘Šã€‚

ğŸ‘‰ **ç‚¹å‡»é˜…è¯»ï¼š[MySQL è¿æ¥æ± ä¸¥é‡é€»è¾‘ç¼ºé™·ä¿®å¤æŠ¥å‘Š (P0çº§æ•…éšœå¤ç›˜)](docs/BUG_FIX_REPORT_CONNECTION_POOL.md)**

*   **é—®é¢˜æ ¹å› **ï¼šåŒæ­¥é”ç«äº‰å¯¼è‡´ Reactor çº¿ç¨‹è¢«æ•°æ®åº“ IO é˜»å¡ï¼Œä¸”ç¼ºä¹è¿æ¥æ¢æ´»æœºåˆ¶å¯¼è‡´â€œæ¯’ä¸¸æ•ˆåº”â€ã€‚
*   **è§£å†³æ–¹æ¡ˆ**ï¼šé‡æ„ä¸ºå…¨å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—æ¨¡å‹ï¼Œå¼•å…¥ `wait_for` è¶…æ—¶æœºåˆ¶ä¸ `ConnectionGuard` (RAII) è‡ªåŠ¨ç®¡ç†ã€‚

---

## ğŸ”¨ æ„å»ºä¸è¿è¡Œ (Build)

### å‰ç½®ä¾èµ–
*   CMake >= 3.10
*   Boost >= 1.70
*   MySQL Connector/C++
*   Protobuf & gRPC
*   Qt5 (ä»…å®¢æˆ·ç«¯éœ€è¦)

### ç¼–è¯‘æœåŠ¡ç«¯

```bash
mkdir build && cd build
cmake ..
make -j4
```

### å¯åŠ¨é›†ç¾¤

```bash
# å¯åŠ¨é¡ºåºå»ºè®®ï¼š
./StatusServer
./GateServer
./ChatServer
./ChatServer2  # å¯åŠ¨ç¬¬äºŒä¸ªä¸šåŠ¡èŠ‚ç‚¹
```